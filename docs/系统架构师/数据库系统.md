## 数据库系统

### 事务

数据库系统中，**“事务”是访问并可能更新各种数据项的一个程序执行单元**。为了保证数据完整性，要求数据库系统维护事务的**原子性**、**一致性**、**隔离性**和**持久性**。

为了实现**原子性**和**持久性**的最为简单的策略：“**影子拷贝**”。该策略假设在某一个时刻只有一个活动的事务，首先对数据库做副本(称为影子副本)，并在磁盘上维护一个 dp_pointer 指针，指向数据库的当前副本。对于要执行写操作的数据项，数据库系统在磁盘上维护数据库的一个副本，所有的写操作都在数据库副本上执行，而保持原始数据库不变，如果在任一时刻操作不得不中止， 系统仅需要删除新副本，原数据库副本没有受到任何影响。

事务的**一致性**要求在没有其他事务并发执行的情况下，事务的执行应该保证数据库的一致性。数据库系统通常采用**完整性约束**检查机制保证单个事务的一致性。

**两阶段锁协议**是实现事务**隔离性**的常见方案，该协议通过定义锁的增长和收缩两个阶段约束事务的加锁和解锁过程，能够保证事务的串行化执行，但由于事务不能一次得到所有需要的锁，因此该协议会可能会导致死锁。

### 数据库恢复机制

#### 基于日志的延迟修改技术(deferred-modification technique)

该技术**通过在日志中记录所有对数据库的修改操作，将一个事务的所有写操作延迟到事务提交后才执行**， 曰志中需要记录“**事务开始**”和“**事务提交**”时间，还需要记录数据项被事务**修改后的新值**，无需记录数据项被事务修改前的原始值。当系统发生故障时，如果某个事务已经开始，但没有提交，则该事务对数据项的修改尚未体现在数据库中，因此无需做任何恢复动作

### 分布式数据库

- 分片透明是指用户或应用程序不需要知道逻辑上访问的表具体是怎么分块存储的；
- 复制透明是指采用复制技术的分布方法，用户不需要知道数据是复制到哪些节点，如何复制的；
- 位置透明是指用户无须知道数据存放的物理位置；
- 逻辑透明，即局部数据模型透明，是指用户或应用程序无须知道局部场地使用的是哪种数据模型；

#### 二阶段提交

二阶段提交(Two-phaseCommit)是指，在计算机网络以及数据库领域内，为了使基于分布式系统架构下的所有节点在**进行事务提交时保持一致性**而设计的一种算法(Algorithm)。通常，二阶段提交也被称为是一种协议(Protocol))。在分布式系统中，每个节点虽然可以知晓自己的操作时成功或者失败，却无法知道其他节点的操作的成功或失败。当一个事务跨越多个节点时，为了保持事务的 ACID 特性[^1]，需要引入一个作为协调者的组件来统一掌控所有节点(称作参与者)的操作结果并最终指示这些节点是否要把操作结果进行真正的提交(比如将更新后的数据写入磁盘等等)。因此，二阶段提交的算法思路可以概括为：**参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中止操作**。

所谓的两个阶段是指：第一阶段：准备阶段(表决阶段)和第二阶段：提交阶段(执行阶段)。

- 准备阶段：事务协调者(事务管理器)给每个参与者(资源管理器)发送 Prepare 消息，每个参与者要么直接返回失败(如权限验证失败)，要么在本地执行事务，写本地的 redo 和 undo 日志，但不提交，到达一种万事俱备，只欠东风的状态。
- 提交阶段：如果协调者收到了参与者的失败消息或者超时，直接给每个参与者发送回滚(Rollback)消息；否则，发送提交(Commit)消息；参与者根据协调者的指令执行提交或者回滚操作，释放所有事务处理过程中使用的锁资源。(注意:必须在最后阶段释放锁资源)

### 数据的转储

数据的转储分为静态转储和动态转储、海量转储和增量转储。 ① 静态转储和动态转储。静态转储是指在转储期间不允许对数据库进行任何存取、修改操作；动态转储是在转储期间允许对数据库进行存取、修改操作，故转储和用户事务可并发执行。 ② 海量转储和增量转储。海量转储是指每次转储全部数据；增量转储是指每次只转储上次转储后更新过的数据。 综上所述，假设系统中有运行的事务，若要转储全部数据库应采用动态全局转储方式。

### 数据库的反规范化

#### 四种方法

反规范化主要有四种方法

1. 增加冗余列(复制某一列的数据)
2. 增加派生列(计算总和，平均值..)
3. 表合并(把部分来自不同表的常用列合并成新表)
4. 表分割(把数据拆分为常用和不常用，行拆分是比如订单信息，列拆分比如账户信息<额外的住址之类的并不常用，减少查询压力>)

#### 解决一致性的方法

1. 使用事物方式(应用程序自己去维护)
2. 使用批处理(写个脚本定时去同步，适合数据不实时更新)
3. 使用触发器(数据库触发器可以在修改时 s 自动更新)

### NoSQL

#### 定义

NoSQL(Not only SQL)是对不同于传统的关系数据库的数据库管理系统的统称，即广义地来说可以把所有不是关系型数据库的数据库统称为 NoSQL。

NoSQL 数据库专门构建用于特定的数据模型，并且具有灵活的架构来构建现代应用程序。NoSQL 数据库使用各种数据模型来访问和管理数据。这些类型的数据库专门针对需要**大数据量**、**低延迟**和灵**活数据模型**的应用程序进行了优化，这是**通过放宽其他数据库的某些数据一致性限制来实现的**。

#### NoSQL 常见类型

- 键值数据库

- 内存数据库

- 文档数据库

- 图形数据库

- 搜索数据库

#### NoSQL 与关系型数据库的区别

下面是 NoSQL 与关系型数据库之间主要区别的表格形式：

|    特点    |                         NoSQL                          |                   关系型数据库                    |
| :--------: | :----------------------------------------------------: | :-----------------------------------------------: |
|  数据模型  |      灵活的数据模型，如键值对、文档、列式、图形等      |         固定的表结构，基于行和列的二维表          |
|   扩展性   |              易于水平扩展，支持分布式架构              |           扩展性有限，主要依赖垂直扩展            |
| 数据一致性 |       通常支持最终一致性（Eventual Consistency）       |             追求强一致性（ACID 事务）             |
| 数据可靠性 |    依赖于特定的实现和配置，可能不如关系型数据库成熟    | 经过多年发展，具有成熟的事务处理机制和可靠性保证  |
|  查询能力  | 查询能力因 NoSQL 类型而异，可能没有 SQL 那么强大和灵活 |     提供了丰富的 SQL 查询操作和强大的聚合函数     |
|  复杂查询  |       复杂查询可能受限，取决于具体的 NoSQL 实现        |           支持复杂的 SQL 查询和联接操作           |
|  数据大小  |                  适用于处理大规模数据                  |          在处理大规模数据时性能可能受限           |
|  数据结构  |           支持非结构化、半结构化和结构化数据           |                主要支持结构化数据                 |
|  读写性能  |    写入性能通常优于关系型数据库，读取性能取决于实现    |      读写性能均衡，但在高并发写入时可能受限       |
|   实时性   |          适用于实时应用，如物联网、在线分析等          | 实时性可能不如 NoSQL 数据库，但在事务处理方面更强 |
|  社区支持  |          不同的 NoSQL 数据库有不同的社区支持           |    关系型数据库具有广泛的社区支持和丰富的生态     |
| 工具和支持 |        工具和支持可能因 NoSQL 数据库的不同而异         |            拥有成熟的工具链和生态系统             |

#### 优缺点

##### 优点

- NoSQL 数据库**支持高并发**数据访问，性能较高。
- NoSQL 数据库的数据**存储结构松散**，能够灵活支持多种类型的数据格式。
- NoSQL 数据库能够支持海量数据的存储，且**易于横向扩展**。
- NoSQL 数据库基于分布式数据存储，**不存在单点故障和性能瓶颈，系统可用性高**。

##### 缺点

- NoSQL 数据库的现有产品不够成熟，大多数产品处于初创期。
- NoSQL 数据库并未形成一定的标准，产品种类繁多，缺乏官方支持。
- NoSQL 数据库不提供对 SQL 的支持，学习和应用迁移成本较高。
- NoSQL 数据库支持的特性不够丰富，现有产品提供的功能比较有限。

### Redis

> 推荐文章：
>
> - [【超级详细】一文搞懂 redis 的所有知识点 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/663851226)

Redis，英文全称是**Remote Dictionary Server**（远程字典服务），是一个开源的使用 ANSI C 语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value 数据库，并提供多种语言的 API。

#### 五种基本数据类型

- String（字符串）
- Hash（哈希）
- List（列表）
- Set（集合）
- zset（有序集合）

#### 常见问题

- 缓存击穿
- 缓存穿透
- 缓存雪崩

#### 常用应用场景

- 缓存
- 排行榜
- 计数器应用
- 共享 Session
- 分布式锁
- 社交[网络](https://link.zhihu.com/?target=https%3A//activity.huaweicloud.com/free_test/index.html%3Futm_source%3Dhwc-csdn%26utm_medium%3Dshare-op%26utm_campaign%3D%26utm_content%3D%26utm_term%3D%26utm_adplace%3DAdPlace070851)
- 消息队列
- 位操作

#### 持久化——RDB 和 AOF

##### RDB（Redis Database）持久化

内存数据以快照的形式保存到磁盘上。

###### 优点

- 适合大规模的数据恢复场景，如备份，全量复制等

###### 缺点

- 没办法做到实时持久化/秒级持久化。
- 新老版本存在 RDB 格式兼容问题

##### **AOF（append only file）** 持久化

采用日志的形式来记录每个写操作，追加到文件中，重启时再重新执行 AOF 文件中的命令来恢复数据。它主要解决数据持久化的实时性问题。默认是不开启的。

###### 优点

- 数据的一致性和完整性更高

###### 缺点

- AOF 记录的内容越多，文件越大，数据恢复变慢。

#### 高可用性

Redis 实现高可用有三种部署模式：**主从模式，哨兵模式，集群模式**。

#### MySQL 与 Redis 如何保证双写一致性

- 缓存延时双删
- 删除缓存重试机制
- 读取 biglog 异步删除缓存

[^1]: ACID 特性：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）
