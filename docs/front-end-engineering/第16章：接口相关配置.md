# 接口相关配置

接口特指前后端分离开发中，前端向后端发起 HTTP 请求的接口，是前后端分离开发的重要环节。组织合理，配置妥当的接口配置，可以极大提高开发效率，降低维护成本。因此，接口相关的配置是项目开发中必不可少的一环。

在进行接口配置时，我们需要尽可能的考虑到各种情况，还需保证接口配置的灵活性，以适应项目需求的变化。具体来说，可以从以下几个方面着手：

- 接口相关文件组织
- 接口地址配置
- 请求拦截器
- 响应拦截器(响应状态码配置)
- 请求超时时间
- 跨域配置
- 接口数据处理（请求数据转化、响应数据转化、请求头封装）

本文将基于 Vue 和 Axios，介绍接口相关配置的内容。

## 接口相关文件组织

接口相关文件的组织目的是为了使得接口文件结构清晰，便于维护与阅读。涉及的内容包括文件夹组织、文件内容组织等。

下面，将依次介绍文件内容组织、文件夹组织内容。

### 文件内容组织

接口相关内容主要包括**接口配置**、**接口请求函数**两部分。接口配置包括请求/响应拦截器的封装、请求超时时间设置、跨域配置、请求头封装等，这些配置通常整合为一个`config.js`文件；接口请求函数是接口请求的封装，通常与项目的模块划分方式保持一致，一个模块对应一个接口请求函数文件。例如，项目包含用户管理、商品管理、订单管理三个模块，那么应创建`user.js`、`product.js`、`order.js`三个接口文件。每个接口文件中定义与对应模块相关的所有接口。此外，一个基础接口函数需要包括**请求方法**和**请求地址**。复杂的接口函数还可以包括**请求参数封装**、**请求头设置**、**响应数据处理**等。

配置文件示例：

```js
// 文件地址：api/config.js
import axios from 'axios'

const instance = axios.create({
  baseURL: 'http://localhost:3000/api',
  timeout: 5000,
  withCredentials: true
})

// 请求拦截器
instance.interceptors.request.use(
  (config) => {
    // 在发送请求之前做些什么
    // 可以在这里设置请求头、请求参数等
    return config
  },
  (error) => {
    // 对请求错误做些什么
    return Promise.reject(error)
  }
)

// 响应拦截器
instance.interceptors.response.use(
  (response) => {
    // 对响应数据做点什么
    // 可以在这里处理响应数据
    return response.data
  },
  (error) => {
    // 对响应错误做点什么
    return Promise.reject(error)
  }
)

export default instance
```

请求函数文件示例：

```js
// 文件地址：api/user.js
import instance from './config'

// 用户登录
export const login = (data) => {
  return instance.post('/user/login', data)
}

// 用户注册
export const register = (data) => {
  return instance.post('/user/register', data)
}

// 获取用户信息
export const getUserInfo = () => {
  return instance.get('/user/info')
}
```

### 文件夹组织

大多数情况下，接口相关文件会放在项目的 `api` 文件夹中。该文件夹可以在项目的根目录下创建，也可以在项目的 `src` 文件夹下创建。如果某个模块的接口特别多，可以在`api` 文件夹下创建与模块对应的子文件夹，用于对接口文件进行更细致的分类。

```
src
├── api
│   ├── config.js
│   ├── user.js
│   ├── product
│   │   ├── 3c.js
│   │   ├── general.js
│   │   └── index.js
│   └── order.js
```

在上述组织方式中，`config.js`是配置文件。`user.js`、`product/`、`order.js`分别对应用户管理、商品管理、订单管理的接口文件。其中商品管理接口文件`product/`下又分划分`3c.js`、`general.js`两个文件，分别对应 3C 产品、一般商品的接口。而`product/index.js`则是商品接口的汇总。

## 接口配置封装

明确了接口文件的组织方式后，接下来，我们来看一下如何进行接口配置的封装。

接口配置封装的目的是为了使得接口配置更加通用、灵活，降低接口配置的维护成本。在进行接口配置封装时，不但要尽可能的让配置项兼顾到各种情况，还要保证配置的灵活性，以适应项目需求的变化。换句话说，接口配置封装要兼顾**通用性**和**灵活性**。通用性要求封装好的接口配置能够使得开发者只需要关注接口请求函数的编写，而无需关心接口配置的细节；灵活性则要求接口配置能够根据项目需求的变化进行灵活配置，覆盖默认的配置项。

接口配置主要包括**请求拦截器**、**响应拦截器**、**请求超时时间**、**跨域配置**、**请求头封装**和**接口地址配置**。下面将介绍如何完成上述接口配置封装。

### 接口地址配置

在 Axios 中，接口地址分为接口请求的基础地址和接口请求的路径。接口请求的基础地址通常为接口请求的域名和端口（如：`http://localhost:3000/api`），主要通过`baseURL`配置项进行设置。接口请求的路径则是在接口请求的基础地址的基础上，添加具体的接口路径（如：`/user/login`），通常在接口请求函数中设置。需要注意的是，Axios 规定，如果接口请求的路径是一个绝对路径（即，完整的 url），则不会拼接基础地址。

```js
// 文件地址：api/config.js
import axios from 'axios'

const instance = axios.create({
  baseURL: 'http://localhost:3000/api'
})
```

> [!Tip]
> 如果接口地址是以`/`开头，则`baseURl`不能以`/`结尾，否则会拼接出错。

#### 多环境的接口地址配置

在项目开发过程中，通常需要根据不同的环境（如：开发环境、测试环境、生产环境）来配置不同的接口地址。因此，接口地址配置需要支持多环境配置。
在 Vue 项目中，可以通过`process.env`对象来获取环境变量。因此，我们可以将接口地址配置为环境变量，然后在`config.js`文件中根据环境变量来设置接口请求的基础地址。

```bash
# 文件地址：.env.development
VUE_APP_API_BASE_URL=http://localhost:3000/api
```

```bash
# 文件地址：.env.production
VUE_APP_API_BASE_URL=https://api.example.com
```

```js
// 文件地址：api/config.js
import axios from 'axios'

const instance = axios.create({
  baseURL: process.env.VUE_APP_API_BASE_URL
})
```

#### 多服务器的接口地址配置

如果项目需要同时请求多个服务器，则需要实现多个基础地址的配置。

- 创建多个`axios.create`实例，每个实例对应一个基础地址。
- 动态设置`axios.create`实例的`baseURL`属性。
- 每个接口请求函数提供完整的接口地址，用于覆盖`axios.create`实例的`baseURL`属性。

```js
// 文件地址：api/config.js
import axios from 'axios'

const instance1 = axios.create({
  baseURL: 'http://localhost:3000/api'
})

const instance2 = axios.create({
  baseURL: 'http://localhost:4000/api'
})

export { instance1, instance2 }
```
